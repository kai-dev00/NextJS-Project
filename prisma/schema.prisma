generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  
}


model Role {
  // id          Int      @id @default(autoincrement())
   id          String @id @default(cuid())
  name        String   @unique  // "USER", "ADMIN", "MODERATOR"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  invites     UserInvite[]
  permissions Permission[]
}

model Permission {
  id          String  @id @default(cuid())
  action      String  // create, read, update, delete
  module      String  // users, categories, inventory, etc.
  submodule   String  @default("")  // optional for more granular control
  description String  @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles Role[]

  @@unique([action, module, submodule])
  @@index([module])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  fullName  String?
  phoneNumber      String
  roleId    String  
  emailVerifiedAt  DateTime?
  isActive         Boolean  @default(false)

  sessions  Session[]
  passwordResets PasswordReset[]
  actionLogs ActionLog[] 

  role      Role     @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())
  createdBy   String?  // nullable for system-created categories
  updatedAt DateTime @updatedAt
  updatedBy   String?  // nullable for system-updated categories

  @@index([roleId])
}

model UserInvite {
  id          String   @id @default(uuid())
  email       String   @unique
  firstName   String
  lastName    String
  roleId      String
  token       String   @unique
  expiresAt   DateTime
  usedAt      DateTime?

  role        Role     @relation(fields: [roleId], references: [id])
  createdAt   DateTime @default(now())
  createdBy   String?  // nullable for system-created categories
  updatedAt   DateTime @updatedAt  //nullable
  updatedBy   String?  // nullable for system-updated categories

  @@index([roleId])
}


model Session {
  id               String   @id @default(uuid())
  userId           String
  refreshTokenHash String
  expiresAt        DateTime
  revoked          Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) //delete also its sessions when user is deleted

  @@index([userId])
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  @@index([userId])
}


model ActionLog {
  id        String   @id @default(uuid())
  userId    String?           // nullable if SYSTEM action
  module     String            // e.g., "Inventory"
  submodule  String?           // e.g., "Milk", "Syrups"
  action    String            // "create", "update", "delete"
  recordId  String?           
  before    Json?             
  after     Json?             
  createdAt DateTime @default(now())

  user      User? @relation(fields: [userId], references: [id])
  @@index([userId])
  @@index([module])
  @@index([submodule])
  @@index([action])
}


//Modules
model Category {
  id          String  @id @default(cuid())

  name        String   @unique
  description String?
  icon        String?  // emoji
  color       String?  // hex color 
  createdAt   DateTime @default(now())
  createdBy   String?  // nullable for system-created categories
  updatedAt   DateTime @updatedAt  //nullable
  updatedBy   String?  // nullable for system-updated categories

  totalPrice   Float    @default(0) 
  inventories       Inventory[]   
}

enum InventoryStatus {
  in_stock
  low_stock
  out_of_stock
  warning
  discontinued
}
enum InventoryUnit {
  PCS
  KG
  G
  L
  ML
}

model Inventory {
  id          String  @id @default(cuid())
  name        String   @unique
  description String?
  categoryId  String
  quantity    Decimal      @default(0)
  minimumStock Int      @default(0)
  unitPrice   Decimal    @default(0)
  status      InventoryStatus?   // in stock, low stock, critical, out of stock
  unit        InventoryUnit

  createdAt   DateTime @default(now())
  createdBy   String?  // nullable for system-created categories
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // nullable for system-updated categories


  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade) //delete also its inventories when category is deleted
  @@index([categoryId])
}
